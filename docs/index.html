<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>@sharetech-labs/logtrace — Usage Guide</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  /* ============ THEME — dark-first gradient mesh ============ */
  :root {
    --font-body: 'DM Sans', system-ui, sans-serif;
    --font-mono: 'Fira Code', 'SF Mono', Consolas, monospace;

    --bg: #0c0e1a;
    --surface: #141729;
    --surface2: #1a1f38;
    --surface-elevated: #1e2445;
    --border: rgba(255, 255, 255, 0.06);
    --border-bright: rgba(255, 255, 255, 0.12);
    --text: #e2e8f0;
    --text-dim: #7a85a3;

    --cyan: #22d3ee;
    --cyan-dim: rgba(34, 211, 238, 0.1);
    --emerald: #34d399;
    --emerald-dim: rgba(52, 211, 153, 0.1);
    --violet: #a78bfa;
    --violet-dim: rgba(167, 139, 250, 0.1);
    --amber: #fbbf24;
    --amber-dim: rgba(251, 191, 36, 0.1);
    --rose: #fb7185;
    --rose-dim: rgba(251, 113, 133, 0.1);
  }

  @media (prefers-color-scheme: light) {
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --surface2: #f1f5f9;
      --surface-elevated: #ffffff;
      --border: rgba(0, 0, 0, 0.07);
      --border-bright: rgba(0, 0, 0, 0.14);
      --text: #0f172a;
      --text-dim: #64748b;

      --cyan: #0891b2;
      --cyan-dim: rgba(8, 145, 178, 0.08);
      --emerald: #059669;
      --emerald-dim: rgba(5, 150, 105, 0.08);
      --violet: #7c3aed;
      --violet-dim: rgba(124, 58, 237, 0.08);
      --amber: #d97706;
      --amber-dim: rgba(217, 119, 6, 0.08);
      --rose: #e11d48;
      --rose-dim: rgba(225, 29, 72, 0.08);
    }
  }

  /* ============ RESET + BASE ============ */
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    background-image:
      radial-gradient(ellipse at 15% 5%, var(--cyan-dim) 0%, transparent 45%),
      radial-gradient(ellipse at 85% 15%, var(--violet-dim) 0%, transparent 40%),
      radial-gradient(ellipse at 50% 80%, var(--emerald-dim) 0%, transparent 40%);
    color: var(--text);
    font-family: var(--font-body);
    padding: 48px 40px;
    min-height: 100vh;
    overflow-wrap: break-word;
  }

  /* ============ ANIMATION ============ */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeScale {
    from { opacity: 0; transform: scale(0.94); }
    to { opacity: 1; transform: scale(1); }
  }

  .anim {
    animation: fadeUp 0.5s ease-out both;
    animation-delay: calc(var(--i, 0) * 0.07s);
  }
  .anim-scale {
    animation: fadeScale 0.4s ease-out both;
    animation-delay: calc(var(--i, 0) * 0.07s);
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-delay: 0ms !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* ============ LAYOUT ============ */
  .container {
    max-width: 1060px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
  }

  /* ============ HERO ============ */
  .hero {
    text-align: center;
    margin-bottom: 12px;
    padding: 32px 24px 28px;
  }

  .hero-pkg {
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 500;
    color: var(--cyan);
    letter-spacing: 0.5px;
    margin-bottom: 12px;
  }

  h1 {
    font-size: 44px;
    font-weight: 700;
    letter-spacing: -1.5px;
    line-height: 1.1;
    margin-bottom: 12px;
    text-wrap: balance;
  }

  h1 span { color: var(--cyan); }

  .hero-desc {
    color: var(--text-dim);
    font-size: 16px;
    line-height: 1.6;
    max-width: 560px;
    margin: 0 auto 20px;
  }

  .badges {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .badge {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-bright);
    background: var(--surface);
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .badge .dot {
    width: 6px; height: 6px; border-radius: 50%;
  }

  .install-cmd {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: 8px;
    padding: 10px 20px;
    font-family: var(--font-mono);
    font-size: 13px;
    color: var(--text);
    cursor: default;
  }
  .install-cmd .prompt { color: var(--cyan); user-select: none; }

  /* ============ FLOW ARROW ============ */
  .flow-arrow {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 10px 0;
  }
  .flow-arrow svg {
    width: 20px; height: 20px; fill: none;
    stroke: var(--border-bright); stroke-width: 2;
    stroke-linecap: round; stroke-linejoin: round;
  }

  /* ============ SECTION CARDS ============ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px 28px;
    position: relative;
  }
  .card--hero {
    background: var(--surface-elevated);
    border-color: var(--border-bright);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
  }

  .card-label {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-label .dot {
    width: 7px; height: 7px; border-radius: 50%; display: inline-block;
  }

  /* ============ CODE + TREE SPLIT ============ */
  .split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .split > * { min-width: 0; }

  /* Code block */
  .code-block {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px 22px;
    overflow-x: auto;
    font-family: var(--font-mono);
    font-size: 12.5px;
    line-height: 1.75;
    color: var(--text);
    white-space: pre;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .code-block::-webkit-scrollbar { height: 4px; }
  .code-block::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Syntax colors */
  .kw { color: var(--violet); }
  .fn { color: var(--cyan); }
  .str { color: var(--emerald); }
  .num { color: var(--amber); }
  .cmt { color: var(--text-dim); font-style: italic; }
  .type { color: var(--rose); }

  /* ============ MERMAID CONTAINER ============ */
  .mermaid-wrap {
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px 20px;
    overflow: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .mermaid-wrap::-webkit-scrollbar { width: 5px; height: 5px; }
  .mermaid-wrap::-webkit-scrollbar-track { background: transparent; }
  .mermaid-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .mermaid-wrap .mermaid {
    display: flex;
    justify-content: center;
    transition: transform 0.2s ease;
    transform-origin: top center;
  }

  .zoom-controls {
    position: absolute;
    top: 8px; right: 8px;
    display: flex; gap: 2px;
    z-index: 10;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 2px;
  }
  .zoom-controls button {
    width: 26px; height: 26px;
    border: none; background: transparent;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 13px; cursor: pointer;
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.15s ease, color 0.15s ease;
  }
  .zoom-controls button:hover {
    background: var(--border);
    color: var(--text);
  }
  .mermaid-wrap.is-zoomed { cursor: grab; }
  .mermaid-wrap.is-panning { cursor: grabbing; user-select: none; }

  .mermaid .nodeLabel {
    font-family: var(--font-body) !important;
    font-size: 14px !important;
  }
  .mermaid .edgeLabel {
    font-family: var(--font-mono) !important;
    font-size: 12px !important;
  }
  .mermaid .node rect,
  .mermaid .node circle,
  .mermaid .node polygon {
    stroke-width: 1.5px !important;
  }
  .mermaid .edge-pattern-solid { stroke-width: 1.5px !important; }

  /* ============ OUTPUT FORMATS ============ */
  .outputs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
  }

  .output-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .output-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }

  .output-card .method {
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 7px;
  }
  .output-card .method .dot {
    width: 7px; height: 7px; border-radius: 50%;
  }

  .output-card .desc {
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.5;
    margin-bottom: 12px;
  }

  .output-card .preview {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 10px 12px;
    font-family: var(--font-mono);
    font-size: 10px;
    line-height: 1.6;
    color: var(--text-dim);
    overflow-x: auto;
    white-space: pre;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    max-height: 140px;
    overflow-y: auto;
  }
  .output-card .preview::-webkit-scrollbar { height: 3px; width: 3px; }
  .output-card .preview::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* ============ CONCEPT CALLOUT ============ */
  .callout {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--violet);
    border-radius: 0 12px 12px 0;
    padding: 20px 24px;
  }
  .callout-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--violet);
  }
  .callout-body {
    font-size: 13px;
    line-height: 1.7;
    color: var(--text-dim);
  }
  .callout-body code {
    font-family: var(--font-mono);
    font-size: 11px;
    background: var(--violet-dim);
    color: var(--violet);
    padding: 2px 6px;
    border-radius: 4px;
  }

  .callout-code {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    margin-top: 12px;
    font-family: var(--font-mono);
    font-size: 12px;
    line-height: 1.7;
    white-space: pre;
    overflow-x: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .callout-code::-webkit-scrollbar { height: 4px; }
  .callout-code::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* ============ API SUMMARY ============ */
  .api-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .api-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
  }
  .api-item .name {
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 600;
    color: var(--cyan);
    margin-bottom: 4px;
  }
  .api-item .sig {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .api-item .note {
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.5;
  }

  /* ============ SPACER ============ */
  .gap { height: 20px; }
  .gap-sm { height: 12px; }

  /* ============ RESPONSIVE ============ */
  @media (max-width: 860px) {
    body { padding: 20px 16px; }
    h1 { font-size: 28px; }
    .split { grid-template-columns: 1fr; }
    .outputs { grid-template-columns: 1fr 1fr; }
    .api-grid { grid-template-columns: 1fr; }
    .mermaid-wrap { padding: 16px 12px; }
  }
  @media (max-width: 500px) {
    .outputs { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="container">

  <!-- ═══════ HERO ═══════ -->
  <div class="hero anim" style="--i:0">
    <div class="hero-pkg">@sharetech-labs/logtrace</div>
    <h1>Structured Decision <span>Tracing</span></h1>
    <p class="hero-desc">
      One method. Automatic scoping. Every <code style="font-family:var(--font-mono);font-size:13px;background:var(--cyan-dim);color:var(--cyan);padding:2px 6px;border-radius:4px">.log()</code>
      call returns a context that can parent further entries &mdash; the tree builds itself.
    </p>
    <div class="badges">
      <div class="badge"><span class="dot" style="background:var(--emerald)"></span> Zero Dependencies</div>
      <div class="badge"><span class="dot" style="background:var(--cyan)"></span> TypeScript</div>
      <div class="badge"><span class="dot" style="background:var(--violet)"></span> ESM + CJS</div>
      <div class="badge"><span class="dot" style="background:var(--amber)"></span> MIT</div>
    </div>
    <div class="install-cmd">
      <span class="prompt">$</span> npm i @sharetech-labs/logtrace
    </div>
  </div>

  <!-- ═══════ YOU WRITE THIS ═══════ -->
  <div class="flow-arrow anim" style="--i:1">
    <svg viewBox="0 0 20 20"><path d="M10 4 L10 16 M6 12 L10 16 L14 12"/></svg>
    you write this
  </div>

  <div class="split anim" style="--i:2">
    <!-- Code input -->
    <div>
      <div class="card-label" style="color:var(--cyan)"><span class="dot" style="background:var(--cyan)"></span> Input Code</div>
      <div class="code-block"><span class="kw">import</span> { <span class="type">Trace</span> } <span class="kw">from</span> <span class="str">"@sharetech-labs/logtrace"</span>;

<span class="kw">const</span> trace = <span class="kw">new</span> <span class="fn">Trace</span>(<span class="str">"order-123"</span>, {
  customer: <span class="str">"C-2041"</span>
});

<span class="cmt">// .log() returns a context for nesting</span>
<span class="kw">const</span> pricing = trace.<span class="fn">log</span>(<span class="str">"pricing"</span>, {
  subtotal: <span class="num">284.97</span>
});

<span class="kw">const</span> discount = pricing.<span class="fn">log</span>(<span class="str">"apply-discount"</span>, {
  code: <span class="str">"SAVE20"</span>
});

discount.<span class="fn">log</span>(<span class="str">"result"</span>, {
  new_subtotal: <span class="num">227.98</span>
});

trace.<span class="fn">log</span>(<span class="str">"payment"</span>, {
  amount: <span class="num">227.98</span>,
  approved: <span class="kw">true</span>
});</div>
    </div>

    <!-- Tree visualization -->
    <div>
      <div class="card-label" style="color:var(--emerald)"><span class="dot" style="background:var(--emerald)"></span> Resulting Trace Tree</div>
      <div class="mermaid-wrap">
        <div class="zoom-controls">
          <button onclick="zoomDiagram(this, 1.2)" title="Zoom in">+</button>
          <button onclick="zoomDiagram(this, 0.8)" title="Zoom out">&minus;</button>
          <button onclick="resetZoom(this)" title="Reset zoom">&#8634;</button>
        </div>
        <pre class="mermaid">
graph TD
    root["order-123"]
    n1["pricing"]
    n2["apply-discount"]
    n3["result"]
    n4["payment"]
    root -->|1| n1
    root -->|2| n4
    n1 --> n2
    n2 --> n3
        </pre>
      </div>
      <div style="text-align:center;margin-top:8px">
        <span style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);letter-spacing:0.5px">
          tree emerges from which node you call .log() on
        </span>
      </div>
    </div>
  </div>

  <!-- ═══════ OUTPUT FORMATS ═══════ -->
  <div class="flow-arrow anim" style="--i:3">
    <svg viewBox="0 0 20 20"><path d="M10 4 L10 16 M6 12 L10 16 L14 12"/></svg>
    4 output formats
  </div>

  <div class="outputs">
    <div class="output-card anim-scale" style="--i:4">
      <div class="method"><span class="dot" style="background:var(--cyan)"></span> .toJSON()</div>
      <div class="desc">Full nested tree. Store in JSONB, S3, or structured logs.</div>
      <div class="preview">{
  "id": "order-123",
  "data": { "customer": "C-2041" },
  "timestamp": "2025-...",
  "children": [
    {
      "label": "pricing",
      "data": { "subtotal": 284.97 },
      "children": [...]
    },
    ...
  ]
}</div>
    </div>

    <div class="output-card anim-scale" style="--i:5">
      <div class="method"><span class="dot" style="background:var(--emerald)"></span> .summary()</div>
      <div class="desc">Human-readable ASCII tree for logs and debugging.</div>
      <div class="preview">order-123
&#9500;&#9472; pricing (subtotal=284.97)
&#9474;  &#9492;&#9472; apply-discount (code=SAVE20)
&#9474;     &#9492;&#9472; result (new_subtotal=227.98)
&#9492;&#9472; payment (amount=227.98, approved=true)</div>
    </div>

    <div class="output-card anim-scale" style="--i:6">
      <div class="method"><span class="dot" style="background:var(--amber)"></span> .flat()</div>
      <div class="desc">Chronological array. Query across traces with SQL.</div>
      <div class="preview">[
  { label: "pricing",
    _depth: 1, ... },
  { label: "apply-discount",
    _depth: 2, ... },
  { label: "result",
    _depth: 3, ... },
  { label: "payment",
    _depth: 1, ... }
]</div>
    </div>

    <div class="output-card anim-scale" style="--i:7">
      <div class="method"><span class="dot" style="background:var(--violet)"></span> .mermaid()</div>
      <div class="desc">Flowchart syntax. Paste into docs, PRs, or render live.</div>
      <div class="preview">graph TD
    root["order-123"]
    n1["pricing"]
    root --> n1
    n2["apply-discount"]
    n1 --> n2
    n3["result"]
    n2 --> n3
    n4["payment"]
    root --> n4</div>
    </div>
  </div>

  <!-- ═══════ CORE CONCEPT ═══════ -->
  <div class="gap"></div>

  <div class="callout anim" style="--i:8">
    <div class="callout-title">Pass TraceContext Through Your Functions</div>
    <div class="callout-body">
      Functions accept <code>TraceContext</code> &mdash; they don't know or care where they sit in the tree.
      Call <code>.log()</code> on the context you receive and children nest automatically.
    </div>
    <div class="callout-code"><span class="kw">function</span> <span class="fn">applyDiscount</span>(ctx: <span class="type">TraceContext</span>, code: <span class="type">string</span>) {
  <span class="kw">const</span> node = ctx.<span class="fn">log</span>(<span class="str">"apply-discount"</span>, { code });
  <span class="kw">const</span> result = <span class="fn">calculateDiscount</span>(code);
  node.<span class="fn">log</span>(<span class="str">"result"</span>, { amount: result });
  <span class="kw">return</span> result;
}

<span class="cmt">// Nests correctly under whichever parent calls it</span>
<span class="fn">applyDiscount</span>(pricingNode, <span class="str">"SAVE20"</span>);</div>
  </div>

  <!-- ═══════ API AT A GLANCE ═══════ -->
  <div class="gap"></div>

  <div class="anim" style="--i:9">
    <div class="card-label" style="color:var(--amber)"><span class="dot" style="background:var(--amber)"></span> API at a Glance</div>
    <div class="api-grid">
      <div class="api-item">
        <div class="name">new Trace(id, data?)</div>
        <div class="sig">Creates the root trace node</div>
        <div class="note">The <code style="font-family:var(--font-mono);font-size:10px;background:var(--cyan-dim);color:var(--cyan);padding:1px 4px;border-radius:3px">id</code> becomes the tree root label. Optional <code style="font-family:var(--font-mono);font-size:10px;background:var(--cyan-dim);color:var(--cyan);padding:1px 4px;border-radius:3px">data</code> attaches metadata.</div>
      </div>
      <div class="api-item">
        <div class="name">.log(label, data?)</div>
        <div class="sig">Returns TraceContext</div>
        <div class="note">Logs an entry as a child of the current node. The returned context scopes future children.</div>
      </div>
      <div class="api-item">
        <div class="name">.enableConsoleLogging()</div>
        <div class="sig">Toggles real-time output</div>
        <div class="note">Logs to console as entries are created, indented by depth. Toggle on/off mid-trace.</div>
      </div>
      <div class="api-item">
        <div class="name">.mermaid(options?)</div>
        <div class="sig">direction: TD | LR | BT | RL, order: boolean</div>
        <div class="note">Generates Mermaid flowchart syntax. Enable <code style="font-family:var(--font-mono);font-size:10px;background:var(--cyan-dim);color:var(--cyan);padding:1px 4px;border-radius:3px">order</code> for numbered edges.</div>
      </div>
    </div>
  </div>

  <div class="gap"></div>

  <!-- ═══════ FOOTER ═══════ -->
  <div class="anim" style="--i:10;text-align:center;padding:16px 0">
    <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">
      MIT &middot; zero dependencies &middot; Node &ge; 18
    </span>
  </div>

</div>

<!-- ═══════ MERMAID ═══════ -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    look: 'handDrawn',
    themeVariables: {
      primaryColor: isDark ? '#1e2445' : '#ecfdf5',
      primaryBorderColor: isDark ? '#34d399' : '#059669',
      primaryTextColor: isDark ? '#e2e8f0' : '#0f172a',
      secondaryColor: isDark ? '#1e2445' : '#f0fdf4',
      secondaryBorderColor: isDark ? '#22d3ee' : '#0891b2',
      secondaryTextColor: isDark ? '#e2e8f0' : '#0f172a',
      tertiaryColor: isDark ? '#27201a' : '#fffbeb',
      tertiaryBorderColor: isDark ? '#fbbf24' : '#d97706',
      tertiaryTextColor: isDark ? '#e2e8f0' : '#0f172a',
      lineColor: isDark ? '#4b5563' : '#9ca3af',
      fontSize: '14px',
      fontFamily: "'DM Sans', system-ui, sans-serif",
      noteBkgColor: isDark ? '#1e2445' : '#fefce8',
      noteTextColor: isDark ? '#e2e8f0' : '#0f172a',
      noteBorderColor: isDark ? '#fbbf24' : '#d97706',
    }
  });
</script>

<!-- ═══════ ZOOM CONTROLS ═══════ -->
<script>
  function updateZoomState(wrap) {
    var target = wrap.querySelector('.mermaid');
    var zoom = parseFloat(target.dataset.zoom || '1');
    wrap.classList.toggle('is-zoomed', zoom > 1);
  }

  function zoomDiagram(btn, factor) {
    var wrap = btn.closest('.mermaid-wrap');
    var target = wrap.querySelector('.mermaid');
    var current = parseFloat(target.dataset.zoom || '1');
    var next = Math.min(Math.max(current * factor, 0.3), 5);
    target.dataset.zoom = next;
    target.style.transform = 'scale(' + next + ')';
    updateZoomState(wrap);
  }

  function resetZoom(btn) {
    var wrap = btn.closest('.mermaid-wrap');
    var target = wrap.querySelector('.mermaid');
    target.dataset.zoom = '1';
    target.style.transform = 'scale(1)';
    updateZoomState(wrap);
  }

  document.querySelectorAll('.mermaid-wrap').forEach(function(wrap) {
    wrap.addEventListener('wheel', function(e) {
      if (!e.ctrlKey && !e.metaKey) return;
      e.preventDefault();
      var target = wrap.querySelector('.mermaid');
      var current = parseFloat(target.dataset.zoom || '1');
      var factor = e.deltaY < 0 ? 1.1 : 0.9;
      var next = Math.min(Math.max(current * factor, 0.3), 5);
      target.dataset.zoom = next;
      target.style.transform = 'scale(' + next + ')';
      updateZoomState(wrap);
    }, { passive: false });

    var startX, startY, scrollL, scrollT;
    wrap.addEventListener('mousedown', function(e) {
      if (e.target.closest('.zoom-controls')) return;
      var target = wrap.querySelector('.mermaid');
      if (parseFloat(target.dataset.zoom || '1') <= 1) return;
      wrap.classList.add('is-panning');
      startX = e.clientX; startY = e.clientY;
      scrollL = wrap.scrollLeft; scrollT = wrap.scrollTop;
    });
    window.addEventListener('mousemove', function(e) {
      if (!wrap.classList.contains('is-panning')) return;
      wrap.scrollLeft = scrollL - (e.clientX - startX);
      wrap.scrollTop = scrollT - (e.clientY - startY);
    });
    window.addEventListener('mouseup', function() {
      wrap.classList.remove('is-panning');
    });
  });
</script>

</body>
</html>
